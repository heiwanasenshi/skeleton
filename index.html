<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APW – Scan, Import, Déplacement, Recherche, CSV</title>
  <meta name="theme-color" content="#111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{ --accent:#111; --muted:#666; --line:#e5e5e5; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; color:#111; background:#fff }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid var(--line); border-radius: 14px; padding: 12px 14px; margin-bottom: 12px; background:#fff }
    .btn { display:inline-block; border-radius:10px; padding:10px 14px; border:none; background:var(--accent); color:#fff; font-weight:600; cursor:pointer }
    .btn.alt { background:#eaeaea; color:#111 }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap }
    input, select { padding:10px 12px; border-radius:10px; border:1px solid #ddd; width:100% }
    video { width: 100%; max-height: 38vh; background:#000; border-radius: 12px }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f3f3; display:inline-block }
    .muted { color:var(--muted); font-size: 13px }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .status { display:grid; grid-template-columns: 1fr auto; gap:6px; }
    .ok { color: #0a7a2f; } .bad { color: #b00020; } .warn { color:#8a5b00; }
    .list { display:grid; gap:8px }
    .item { border:1px dashed #ddd; border-radius:12px; padding:8px 10px; display:grid; grid-template-columns: 56px 1fr; gap:10px; align-items:center }
    .thumb { width:56px; height:56px; background:#f3f3f3; border-radius:8px; object-fit:cover }
    .title { font-weight:600 }
    .small { font-size:12px; color:var(--muted) }
    .hidden { display:none }
    progress { width: 100%; height: 10px }
    .tests-pass { color:#0a7a2f; font-weight:600 }
    .tests-fail { color:#b00020; font-weight:600 }
    .grid { display:grid; gap:10px }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
    .movePanel { display:grid; grid-template-columns: 1fr 90px 120px auto; gap:6px; margin-top:6px }
    .toast { position:fixed; left:12px; right:12px; bottom:12px; background:#111; color:#fff; border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 10px 30px rgba(0,0,0,.2); z-index:9999 }
    .toast .btn { background:#fff; color:#111 }
    .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background:#f3f3f3; border: 1px solid #e2e2e2; padding:2px 6px; border-radius:6px; font-size:12px }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:9998 }
    .modal .panel{ background:#fff; border-radius:14px; padding:12px; width:min(780px, 96vw); max-height:88vh; overflow:auto }
    table{ border-collapse:collapse; width:100% }
    th,td{ border:1px solid #eee; padding:6px 8px; font-size:13px }
    th{ background:#fafafa; text-align:left }
    .nowrap{ white-space:nowrap }
  </style>
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <script src="https://unpkg.com/@zxing/browser@0.0.10"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'
    }
  </script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 10px;">APW – Auto-scan, Import numérique, Déplacement, Recherche, CSV</h1>
    <div class="card"><div class="status">
      <div>HTTPS</div><div id="s_https" class="pill">…</div>
      <div>getUserMedia (caméra)</div><div id="s_gum" class="pill">…</div>
      <div>BarcodeDetector natif</div><div id="s_bd" class="pill">…</div>
      <div>ZXing fallback</div><div id="s_zx" class="pill">…</div>
      <div>FS Access API</div><div id="s_fs" class="pill">…</div>
      <div>Top-level (pas dans un cadre)</div><div id="s_top" class="pill">…</div>
    </div></div>

    <div class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <strong>Scanner (auto) — Livres physiques</strong>
        <span class="pill">ISBN/EAN-13</span>
      </div>
      <video id="video" playsinline muted></video>
      <div class="muted" style="margin-top:6px">La détection démarre automatiquement. Bonne lumière & rapproche doucement.</div>
      <div style="margin-top:10px" class="row">
        <input id="manual" placeholder="Saisie manuelle ISBN/EAN (si besoin)" />
        <button id="btnAdd" class="btn alt">Ajouter</button>
        <button id="btnStop" class="btn alt">Arrêter</button>
      </div>
    </div>

    <div class="card">
      <strong>Derniers ajouts (physiques)</strong>
      <div id="resultsPhysical" class="list" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <strong>Tests</strong>
      <ul id="tests" class="small" style="margin-top:8px"></ul>
    </div>

    <div class="card">
      <strong>Logs</strong>
      <pre id="log" class="mono" style="white-space: pre-wrap; margin-top:8px"></pre>
    </div>
  </div>

  <script type="module">
    (function setupPWA(){
      try {
        const ICON_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#111"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, Helvetica, sans-serif" font-size="280" font-weight="700" fill="#fff">A</text></svg>')
        const manifest = { name:'APW – Auto-scan', short_name:'APW', start_url:'.', display:'standalone', background_color:'#ffffff', theme_color:'#111111', icons:[{ src: ICON_SVG, sizes:'any', type:'image/svg+xml', purpose:'any maskable' }] }
        const blob = new Blob([JSON.stringify(manifest)], { type:'application/json' })
        const url = URL.createObjectURL(blob)
        const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link)
        if ('serviceWorker' in navigator) {
          const swCode = "self.addEventListener('install', e=> self.skipWaiting()); self.addEventListener('activate', e=> e.waitUntil(self.clients.claim()));";
          const swBlob = new Blob([swCode], { type:'text/javascript' })
          const swURL = URL.createObjectURL(swBlob)
          navigator.serviceWorker.register(swURL, { scope: './' }).catch(()=>{})
        }
      } catch (e) {}
    })();

    const log = (m)=> { const el=document.getElementById('log'); el.textContent += (m+'\\n'); el.scrollTop = el.scrollHeight }
    const setBadge = (id, ok)=> { const el=document.getElementById(id); el.textContent = ok? 'OUI':'NON'; el.className='pill ' + (ok? 'ok':'bad') }
    const normISBN = (raw)=> { const d=String(raw).replace(/[^0-9Xx]/g,'').toUpperCase(); if (d.length===13) return d; return d }
    const isHttps = location.protocol === 'https:' || location.hostname === 'localhost'
    const hasGUM = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
    const hasBD = 'BarcodeDetector' in window
    const hasZX = !!(window.ZXing && window.ZXing.BrowserMultiFormatReader)
    const isTop = (window.self === window.top)
    setBadge('s_https', isHttps); setBadge('s_gum', hasGUM); setBadge('s_bd', hasBD); setBadge('s_zx', hasZX); setBadge('s_fs', 'showDirectoryPicker' in window); setBadge('s_top', isTop)

    let stream=null, rafId=null, detector=null, zxingReader=null
    const $video = document.getElementById('video')
    const $manual = document.getElementById('manual')

    async function startCamera(){
      if (!hasGUM){ log('Caméra non disponible'); return }
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' } })
        $video.srcObject = stream
        await $video.play()
        log('Caméra démarrée.')
        if (hasBD){
          try { detector = new window.BarcodeDetector({ formats:['ean_13'] }); loopBD(); log('Mode: BarcodeDetector natif') }
          catch (e){ log('BarcodeDetector indisponible → ZXing'); startZXing() }
        } else { startZXing() }
      } catch (e){ log('Échec accès caméra: ' + e.message) }
    }
    function stopCamera(){ if (rafId) cancelAnimationFrame(rafId); rafId=null; if (stream){ stream.getTracks().forEach(t=> t.stop()); stream=null } if (zxingReader){ try{ zxingReader.stopContinuousDecode() }catch{}; zxingReader=null } detector=null; log('Caméra arrêtée.') }
    async function loopBD(){ if (!$video || !detector) return; try { const codes = await detector.detect($video); const code = codes && codes[0] && codes[0].rawValue; if (code) onDecodedPhysical(code) } catch (e){}; rafId = requestAnimationFrame(loopBD) }
    function startZXing(){ if (!hasZX){ log('ZXing non chargé.'); return } try { zxingReader = new ZXing.BrowserMultiFormatReader(); zxingReader.decodeFromVideoDevice(null, 'video', (result) => { if (result && result.getText){ onDecodedPhysical(result.getText()) } }) ; log('Mode: ZXing (fallback)') } catch (e){ log('Erreur ZXing: ' + e.message) } }

    const DB = { items: [], inbox:{name:'A Ranger', items:[]} }
    let lastScanTs = 0, seen = new Set(), SECS_BETWEEN_SAME = 900

    function renderPhysical(){
      const list = document.getElementById('resultsPhysical')
      list.innerHTML = ''
      for (let i=DB.items.length-1; i>=0; i--){
        const it = DB.items[i]; if (it.kind!=='physical') continue
        const row = document.createElement('div'); row.className = 'item'
        row.innerHTML = '<div class=\\"thumb\\"></div><div><div class=\\"title\\">'+(it.metadata.title||'(Sans titre)')+'</div><div class=\\"small\\">ISBN: '+(it.identifiers.isbn13||'')+'</div></div>'
        list.appendChild(row)
      }
    }

    async function lookupGoogleBooks(isbn13){
      try{ const r=await fetch('https://www.googleapis.com/books/v1/volumes?q=isbn:'+encodeURIComponent(isbn13)); if(!r.ok) return null; const j=await r.json(); const it=j.items&&j.items[0]; if(!it) return null; const v=it.volumeInfo||{}; return { title: v.title||'', authors: v.authors||[], publisher: v.publisher||'', year: (v.publishedDate||'').slice(0,4)||'' } }catch(e){ return null }
    }

    async function onDecodedPhysical(code){
      const now = Date.now(); if (now - lastScanTs < SECS_BETWEEN_SAME) return; lastScanTs = now
      const isbn = normISBN(code); if (!isbn) return; if (seen.has(isbn)) return; seen.add(isbn); log('→ Détecté (physique): ' + isbn)
      const d = await lookupGoogleBooks(isbn) || { title:'', authors:[], publisher:'', year:'' }
      const it = { id: 'item_'+Math.random().toString(36).slice(2,9), kind:'physical', identifiers:{ isbn13:isbn }, metadata:{ title:d.title||'', authors:d.authors||[], publisher:d.publisher||'', year:d.year||'' } }
      DB.items.push(it); renderPhysical(); log('✅ Ajouté (physique)')
    }

    document.getElementById('btnAdd').addEventListener('click', ()=>{ const v = normISBN($manual.value); if (!v){ alert('ISBN invalide'); return } onDecodedPhysical(v); $manual.value='' })
    document.getElementById('btnStop').addEventListener('click', stopCamera)
    document.getElementById('video').addEventListener('click', ()=>{ if (!stream) startCamera() })

    window.addEventListener('load', ()=>{ if (isHttps) startCamera(); renderPhysical(); const ul=document.getElementById('tests'); ul.innerHTML='<li class=\\"tests-pass\\">✓ Chargement OK</li>' })
  </script>
</body>
</html>
