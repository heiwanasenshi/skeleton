<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APW – Test mobile</title>
  <meta name="theme-color" content="#111" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; color:#111; background:#fff }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid #e5e5e5; border-radius: 14px; padding: 12px 14px; margin-bottom: 12px; background:#fff }
    .btn { display:inline-block; border-radius:10px; padding:10px 14px; border:none; background:#111; color:#fff; font-weight:600 }
    .btn.alt { background:#eaeaea; color:#111 }
    .row { display:flex; gap:8px; align-items:center }
    input, select { padding:10px 12px; border-radius:10px; border:1px solid #ddd; width:100% }
    video { width: 100%; max-height: 40vh; background:#000; border-radius: 12px }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f3f3; display:inline-block }
    .muted { color:#666; font-size: 13px }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .status { display:grid; grid-template-columns: 1fr auto; gap:6px; }
    .ok { color: #0a7a2f; }
    .bad { color: #b00020; }
    .list { display:grid; gap:8px }
    .item { border:1px dashed #ddd; border-radius:12px; padding:8px 10px }
  </style>
  <!-- ZXing (fallback universel pour iOS/Safari/Android) -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <script src="https://unpkg.com/@zxing/browser@0.0.10"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 10px;">APW – Test mobile (sans Babel)</h1>
    <div class="card">
      <div class="status">
        <div>HTTPS</div><div id="s_https" class="pill">…</div>
        <div>getUserMedia (caméra)</div><div id="s_gum" class="pill">…</div>
        <div>BarcodeDetector natif</div><div id="s_bd" class="pill">…</div>
        <div>ZXing fallback</div><div id="s_zx" class="pill">…</div>
      </div>
      <p class="muted" style="margin-top:8px">Si « Caméra » est NON, activez-la dans le navigateur. Si « natif » est NON, le fallback ZXing prendra le relai.</p>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <strong>Scanner ISBN</strong>
        <span class="pill">ISBN/EAN-13</span>
      </div>
      <div class="row" style="gap:10px; margin-bottom:10px">
        <button id="btnStart" class="btn">Démarrer la caméra</button>
        <button id="btnStop" class="btn alt">Arrêter</button>
      </div>
      <video id="video" playsinline muted></video>
      <div class="muted" style="margin-top:6px">Astuce : bonne lumière et rapprocher doucement. Sur iPhone, utilisez Safari ou Chrome (même moteur).</div>
      <div style="margin-top:10px" class="row">
        <input id="manual" placeholder="Saisie manuelle ISBN/EAN" />
        <button id="btnAdd" class="btn alt">Ajouter</button>
      </div>
    </div>

    <div class="card">
      <strong>File d'attente scannée</strong>
      <div id="queue" class="list" style="margin-top:8px"></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px">
        <button id="btnValidate" class="btn">Valider le lot</button>
      </div>
    </div>

    <div class="card">
      <strong>Logs</strong>
      <pre id="log" class="mono" style="white-space: pre-wrap; margin-top:8px"></pre>
    </div>
  </div>

  <script>
    // ---- util ----
    const log = (m)=> { const el=document.getElementById('log'); el.textContent += (m+'\n'); el.scrollTop = el.scrollHeight }
    const setBadge = (id, ok)=> { const el=document.getElementById(id); el.textContent = ok? 'OUI':'NON'; el.className='pill ' + (ok? 'ok':'bad') }
    const normISBN = (raw)=> { const d=String(raw).replace(/[^0-9Xx]/g,'').toUpperCase(); if (d.length===13) return d; if (d.length===10) return isbn10to13(d); return d }
    function isbn10to13(isbn10){ const core='978'+isbn10.slice(0,9); let sum=0; for(let i=0;i<core.length;i++){ sum+= Number(core[i]) * (i%2===0?1:3) } const check=(10-(sum%10))%10; return core+String(check) }

    // ---- état ----
    let stream = null
    let rafId = null
    let detector = null
    let zxingReader = null
    const q = [] // { isbn, ts }

    // ---- checks ----
    const isHttps = location.protocol === 'https:' || location.hostname === 'localhost'
    const hasGUM = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
    const hasBD = 'BarcodeDetector' in window
    const hasZX = !!(window.ZXing && window.ZXing.BrowserMultiFormatReader)
    setBadge('s_https', isHttps)
    setBadge('s_gum', hasGUM)
    setBadge('s_bd', hasBD)
    setBadge('s_zx', hasZX)

    // ---- UI refs ----
    const $video = document.getElementById('video')
    const $queue = document.getElementById('queue')
    const $btnStart = document.getElementById('btnStart')
    const $btnStop = document.getElementById('btnStop')
    const $manual = document.getElementById('manual')
    const $btnAdd = document.getElementById('btnAdd')
    const $btnValidate = document.getElementById('btnValidate')

    function renderQueue(){
      $queue.innerHTML = ''
      if (!q.length){ $queue.innerHTML = '<div class="muted">(vide)</div>'; return }
      q.forEach(item => {
        const d = document.createElement('div'); d.className='item'; d.textContent = 'ISBN: ' + item.isbn
        $queue.appendChild(d)
      })
    }

    function onDecoded(code){
      const isbn = normISBN(code)
      if (!isbn) return
      if (q.some(x => x.isbn === isbn)) return // éviter doublons immédiats
      q.push({ isbn, ts: Date.now() })
      renderQueue()
      log('→ Détecté: ' + isbn)
    }

    async function startCamera(){
      if (!hasGUM){ log('Caméra non disponible dans ce navigateur.'); return }
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' } })
        $video.srcObject = stream
        await $video.play()
        log('Caméra démarrée.')
        if (hasBD){
          try {
            detector = new window.BarcodeDetector({ formats:['ean_13'] })
            loopBD()
            log('Mode détection: BarcodeDetector natif')
          } catch (e){ log('BarcodeDetector indisponible → fallback ZXing') ; startZXing() }
        } else {
          startZXing()
        }
      } catch (e){ log('Échec accès caméra: ' + e.message) }
    }

    function stopCamera(){
      if (rafId) cancelAnimationFrame(rafId); rafId = null
      if (stream){ stream.getTracks().forEach(t=> t.stop()); stream=null }
      if (zxingReader){ try{ zxingReader.stopContinuousDecode() }catch{}; zxingReader = null }
      detector = null
      log('Caméra arrêtée.')
    }

    async function loopBD(){
      if (!$video || !detector) return
      try {
        const codes = await detector.detect($video)
        const code = codes && codes[0] && codes[0].rawValue
        if (code) onDecoded(code)
      } catch (e){ /* ignore */ }
      rafId = requestAnimationFrame(loopBD)
    }

    function startZXing(){
      if (!hasZX){ log('ZXing non chargé.'); return }
      try {
        zxingReader = new ZXing.BrowserMultiFormatReader()
        zxingReader.decodeFromVideoDevice(null, 'video', (result, err) => {
          if (result && result.getText){ onDecoded(result.getText()) }
        })
        log('Mode détection: ZXing (fallback universel)')
      } catch (e){ log('Erreur ZXing: ' + e.message) }
    }

    // ---- actions ----
    $btnStart.addEventListener('click', startCamera)
    $btnStop.addEventListener('click', stopCamera)
    $btnAdd.addEventListener('click', ()=> { const v = normISBN($manual.value); if (!v){ alert('ISBN invalide'); return } onDecoded(v); $manual.value='' })
    $btnValidate.addEventListener('click', ()=> {
      if (!q.length){ alert('Rien à valider'); return }
      const stored = JSON.parse(localStorage.getItem('apw_scan_demo')||'[]')
      stored.push(...q)
      localStorage.setItem('apw_scan_demo', JSON.stringify(stored))
      q.length = 0
      renderQueue()
      alert('Lot validé (stocké localement).')
    })

    // init
    renderQueue()
  </script>
</body>
</html>
